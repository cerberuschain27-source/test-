name: ZAP DAST (Raw GET/POST)

on:
  push:
  workflow_dispatch:

jobs:
  zap:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Start ZAP daemon
        run: |
          docker run -d --name zap \
            -u root \
            -p 8080:8080 \
            -v ${{ github.workspace }}:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:latest \
            zap.sh -daemon -port 8080 -host 0.0.0.0 \
            -config api.disablekey=true
      - name: Wait for ZAP startup
        run: sleep 20

      # --- IMPORT RAW REQUESTS ---
      - name: Import GET.txt
        run: |
          docker exec zap bash -c "
            curl -s -X POST \
            --data-urlencode \"request=$(cat /zap/wrk/get.txt)\" \
            http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      - name: Import POST.txt
        run: |
          docker exec zap bash -c "
            curl -s -X POST \
            --data-urlencode \"request=$(cat /zap/wrk/post.txt)\" \
            http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      # --- GET ALL IMPORTED URLS ---
      - name: Fetch imported URLs
        id: urls
        run: |
          URLS=$(docker exec zap curl -s \
            http://localhost:8080/JSON/core/view/urls/ | jq -r '.urls[]')
          echo "$URLS"
          echo "urls<<EOF" >> $GITHUB_OUTPUT
          echo "$URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # --- ADD URLs TO SCOPE (CRITICAL STEP) ---
      - name: Add URLs to ZAP Scope
        run: |
          for u in ${{ steps.urls.outputs.urls }}; do
            echo "Adding to scope: $u"
            docker exec zap curl -s \
              "http://localhost:8080/JSON/context/action/includeInContext/?contextName=Default+Context&regex=$(echo $u | sed 's/\//\\\\\//g')"
          done

      # --- ACTIVE SCAN EVERY IN-SCOPE URL ---
      - name: Active Scan
        run: |
          for u in ${{ steps.urls.outputs.urls }}; do
            echo "Active Scanning: $u"
            docker exec zap curl -s \
              "http://localhost:8080/JSON/ascan/action/scan/?url=$u&recurse=true&inScopeOnly=true"
          done

      - name: Wait for scanning
        run: sleep 45

      # --- GENERATE REPORTS ---
      - name: Generate HTML Report
        run: |
          docker exec zap mkdir -p /zap/wrk/reports
          docker exec zap curl -s \
            "http://localhost:8080/OTHER/core/other/htmlreport/" \
            -o /zap/wrk/reports/zap-report.html

      - name: Generate JSON Report
        run: |
          docker exec zap curl -s \
            "http://localhost:8080/OTHER/core/other/jsonreport/" \
            -o /zap/wrk/reports/zap-report.json

      # --- UPLOAD AS ARTIFACT ---
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-results
          path: reports/
