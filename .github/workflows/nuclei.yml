name: ZAP DAST (Raw GET/POST)

on:
  push:
  workflow_dispatch:

jobs:
  zap:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ----------------------------------------------
      # START ZAP IN DAEMON MODE (CORRECT DOCKER IMAGE)
      # ----------------------------------------------
      - name: Start ZAP daemon
        run: |
          docker run -d --name zap \
            -u root \
            -p 8080:8080 \
            -v ${{ github.workspace }}:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:latest \
            zap.sh -daemon -port 8080 -host 0.0.0.0 \
            -config api.disablekey=true

      - name: Wait for ZAP to fully start
        run: sleep 20

      # ----------------------------------------------
      # IMPORT RAW GET REQUEST
      # ----------------------------------------------
      - name: Import GET.txt (raw HTTP)
        run: |
          docker exec zap bash -c "
            echo '=== Importing GET ==='
            curl -s -X POST \
              --data-urlencode \"request=$(cat /zap/wrk/get.txt)\" \
              http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      # ----------------------------------------------
      # IMPORT RAW POST REQUEST
      # ----------------------------------------------
      - name: Import POST.txt (raw HTTP)
        run: |
          docker exec zap bash -c "
            echo '=== Importing POST ==='
            curl -s -X POST \
              --data-urlencode \"request=$(cat /zap/wrk/post.txt)\" \
              http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      # ----------------------------------------------
      # RUN ACTIVE SCAN ON ALL IMPORTED RESOURCES
      # (no hardcoding â€” ZAP scans whatever was imported)
      # ----------------------------------------------
      - name: Start Active Scan
        run: |
          docker exec zap bash -c "
            echo '=== Starting Active Scan ==='
            curl -s 'http://localhost:8080/JSON/ascan/action/scanAllInScope/'
          "

      - name: Wait for scan to finish
        run: sleep 45

      # ----------------------------------------------
      # GENERATE REPORTS
      # ----------------------------------------------
      - name: Generate HTML Report
        run: |
          docker exec zap bash -c "
            mkdir -p /zap/wrk/reports
            /zap/zap.sh -cmd report \
              -o /zap/wrk/reports/zap-report.html -f HTML
          "

      - name: Generate JSON Report
        run: |
          docker exec zap bash -c "
            /zap/zap.sh -cmd report \
              -o /zap/wrk/reports/zap-report.json -f JSON
          "

      # ----------------------------------------------
      # UPLOAD RESULTS
      # ----------------------------------------------
      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-results
          path: reports/
