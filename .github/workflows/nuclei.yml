name: ZAP DAST (Raw GET/POST)

on:
  push:
  workflow_dispatch:

jobs:
  zap:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Debug: show repo contents
      - name: DEBUG â€” Show workspace
        run: |
          echo "=== WORKSPACE ==="
          pwd
          ls -la .

      # Start ZAP with repo mounted correctly
      - name: Start ZAP daemon
        run: |
          docker run -d --name zap \
            -u root \
            -p 8080:8080 \
            -v ${{ github.workspace }}:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:latest \
            zap.sh -daemon -port 8080 -host 0.0.0.0 \
            -config api.disablekey=true

      # Wait for ZAP to start
      - name: Wait for ZAP
        run: sleep 20

      # Import GET request
      - name: Import GET.txt
        run: |
          docker exec zap bash -c "
            echo '=== Importing GET.txt ==='
            curl -s -X POST \
              --data-urlencode \"request=$(cat /zap/wrk/get.txt)\" \
              http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      # Import POST request
      - name: Import POST.txt
        run: |
          docker exec zap bash -c "
            echo '=== Importing POST.txt ==='
            curl -s -X POST \
              --data-urlencode \"request=$(cat /zap/wrk/post.txt)\" \
              http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      # Fetch URLs imported into ZAP
      - name: Fetch URLs
        id: urls
        run: |
          URLS=$(docker exec zap curl -s http://localhost:8080/JSON/core/view/urls/ | jq -r '.urls[]')
          echo "Imported URLs:"
          echo "$URLS"
          echo "urls<<EOF" >> $GITHUB_OUTPUT
          echo "$URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Add URLs to ZAP scope
      - name: Add URLs to Scope
        run: |
          for u in ${{ steps.urls.outputs.urls }}; do
            echo "Adding to scope: $u"
            docker exec zap curl -s \
              "http://localhost:8080/JSON/context/action/includeInContext/?contextName=Default+Context&regex=$(echo $u | sed 's/\//\\\\\//g')"
          done

      # Run Active Scan on all imported URLs
      - name: Active Scan
        run: |
          for u in ${{ steps.urls.outputs.urls }}; do
            echo "Scanning URL: $u"
            docker exec zap curl -s \
              "http://localhost:8080/JSON/ascan/action/scan/?url=$u&recurse=true&inScopeOnly=true"
          done

      # Wait for scan to run
      - name: Wait for scan to finish
        run: sleep 40

      # Generate HTML & JSON reports
      - name: Generate Reports
        run: |
          docker exec zap mkdir -p /zap/wrk/reports
          docker exec zap curl -s \
            "http://localhost:8080/OTHER/core/other/htmlreport/" \
            -o /zap/wrk/reports/zap-report.html
          docker exec zap curl -s \
            "http://localhost:8080/OTHER/core/other/jsonreport/" \
            -o /zap/wrk/reports/zap-report.json

      # Upload results
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-results
          path: reports/
