name: ZAP DAST (Raw GET/POST)

on:
  push:
  workflow_dispatch:

jobs:
  zap:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Start ZAP daemon
        run: |
          docker run -d --name zap \
            -u root \
            -p 8080:8080 \
            -v ${{ github.workspace }}:/zap/wrk \
            ghcr.io/zaproxy/zaproxy:latest \
            zap.sh -daemon -port 8080 -host 0.0.0.0 \
            -config api.disablekey=true

      - name: Wait for ZAP to start
        run: sleep 20

      - name: Import GET.txt (raw HTTP)
        run: |
          docker exec zap bash -c "
            curl -s -X POST \
              --data-urlencode 'request=$(cat /zap/wrk/get.txt)' \
              http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      - name: Import POST.txt (raw HTTP)
        run: |
          docker exec zap bash -c "
            curl -s -X POST \
              --data-urlencode 'request=$(cat /zap/wrk/post.txt)' \
              http://localhost:8080/JSON/importurls/action/importRawHttpRequest/
          "

      # -------------------------------------------------
      # Get all imported URLs and start scan on them
      # -------------------------------------------------
      - name: Get imported URLs
        id: urls
        run: |
          URLS=$(docker exec zap curl -s \
            http://localhost:8080/JSON/core/view/urls/ | jq -r '.urls[]')
          echo "$URLS"
          echo "urls<<EOF" >> $GITHUB_OUTPUT
          echo "$URLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Start Active Scan on imported URLs
        run: |
          for u in ${{ steps.urls.outputs.urls }}; do
            echo "Scanning: $u"
            docker exec zap curl -s \
              "http://localhost:8080/JSON/ascan/action/scan/?url=$u"
          done

      - name: Wait for scanning
        run: sleep 40

      # -------------------------------------------------
      # Generate reports using the running ZAP session
      # -------------------------------------------------
      - name: Generate HTML Report
        run: |
          docker exec zap mkdir -p /zap/wrk/reports
          docker exec zap curl -s \
            "http://localhost:8080/OTHER/core/other/htmlreport/" \
            -o /zap/wrk/reports/zap-report.html

      - name: Generate JSON Report
        run: |
          docker exec zap curl -s \
            "http://localhost:8080/OTHER/core/other/jsonreport/" \
            -o /zap/wrk/reports/zap-report.json

      # -------------------------------------------------
      # Upload reports
      # -------------------------------------------------
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-results
          path: reports/
